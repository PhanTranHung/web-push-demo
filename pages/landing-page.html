<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web push</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"
      integrity="sha512-NQfB/bDaB8kaSXF8E77JjhHG5PM6XVRxvHzkZiwl3ddWCEPBa23T76MuWSwAJdMGJnmQqM0VeY9kFszsrBEFrQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    This is web push notification.
    <div id="feature-sw"></div>
    <div id="feature-noti"></div>

    <br />
    <br />

    <div class="flex-box">
      <b>Enable notification to receive latest news from us.</b>
      <button id="btn-noti" onclick="subscribeNotification()">Enable</button>
    </div>
    <br />

    <div>
      <b>Notification Subscription</b>
      <div id="noti-sub"></div>
    </div>

    <div class="br-y3" />

    <form id="noti-form" method="post" action="/notification">
      <textarea class="textarea" name="payload">
{
  "title": "Thông báo tới từ vũ trụ",
  "body": "Chúng tôi đã tìm được ngôi nhà mới cho bạn. Để di chuyển tới, hãy đăng xuất khỏi server trái đất!",
  "icon": "/apple-touch-icon.png",
  "vibrate": [300, 100, 400]
}
      </textarea>
      <div class="flex-box">
        <button type="submit">Send notification to all subscriber</button>
        <div id="noti-res"></div>
      </div>
    </form>
  </body>

  <script>
    const isSupportSw = () => "serviceWorker" in navigator;
    const isSupportNoti = () => "Notification" in window;

    const checkServiceWorker = (htmlTag) => {
      const swTag = document.getElementById("feature-sw");
      if (isSupportSw()) swTag.textContent = "Service worker: supported";
      else swTag.textContent = "Service worker: not supported";

      const notiTag = document.getElementById("feature-noti");
      if (isSupportNoti()) notiTag.textContent = "Notification: supported";
      else notiTag.textContent = "Notification: not supported";

      const notiSubTag = document.getElementById("noti-sub");
      if (isSupportSw() && isSupportNoti()) {
        navigator.serviceWorker.ready
          .then((registration) => registration.pushManager.getSubscription())
          .then(
            (subscription) =>
              (notiSubTag.textContent = JSON.stringify(subscription))
          );
      } else {
        notiSubTag.textContent =
          "Require bold Service Worker and Notification are supported";
      }
    };
    checkServiceWorker();

    function registerServiceWorker() {
      return navigator.serviceWorker.register("/service-worker.js", {
        type: "classic",
      });
    }
    if ("serviceWorker" in navigator) {
      registerServiceWorker().then(console.log);
    }
  </script>

  <script>
    function subscribe(vapidPublicKey) {
      return navigator.serviceWorker.ready.then(function (registration) {
        return registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
        });
      });
    }

    function urlBase64ToUint8Array(str) {
      const padding = "=".repeat((4 - (str.length % 4)) % 4);
      const base64 = (str + padding).replace(/\-/g, "+").replace(/_/g, "/");

      console.log(base64);
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0)));
    }

    function askNotificationPermission() {
      if (!("serviceWorker" in navigator) || !("Notification" in window)) {
        throw new Error("Browser is not support");
      }
      return new Promise((resolve, reject) => {
        const permissionResult = Notification.requestPermission((result) => {
          resolve(result);
        });

        if (permissionResult) {
          permissionResult.then(resolve, reject);
        }
      });
    }

    function subscribeNotification() {
      askNotificationPermission()
        .then((permissionResult) => {
          if (permissionResult !== "granted")
            throw new Error("Permission is not granted");
          return navigator.serviceWorker.ready;
        })
        .then((registration) => {
          return registration.pushManager.getSubscription();
        })
        .then((subscription) => {
          if (!subscription) {
            return fetch("/vapid/public-key")
              .then((res) => res.text())
              .then((vapidPublicKey) => {
                console.log("vapidPublicKey", vapidPublicKey);
                return subscribe(vapidPublicKey);
              });
          } else {
            return subscription;
          }
        })
        .then((subscription) => {
          const sub = JSON.stringify(subscription);
          document.getElementById("noti-sub").textContent = sub;
          console.log("subscription", sub);
          axios({
            method: "POST",
            url: "/notification/subcription",
            data: subscription,
          })
            .then((res) => console.log(res))
            .catch((err) => console.error(err));
        });
    }
  </script>

  <script>
    const getCustomerManifest = () => {
      return {
        name: "Web push",
        short_name: "Web push",
        description: "Demo of web push notification",
        theme_color: "#ffffff",
        start_url: window.location.origin,
        display: "standalone",
        background_color: "#ffffff",
        icons: [
          {
            src: window.location.origin + "/pos-192x192.png",
            sizes: "192x192",
            type: "image/png",
          },
          {
            src: window.location.origin + "/pos-512x512.png",
            sizes: "512x512",
            type: "image/png",
          },
          {
            src: window.location.origin + "/pos-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "any maskable",
          },
        ],
      };
    };

    const attachManifestToDom = (manifest) => {
      const stringManifest = JSON.stringify(manifest);
      const blob = new Blob([stringManifest], { type: "application/json" });
      const manifestURL = URL.createObjectURL(blob);

      const manifestElement = document.createElement("link");
      manifestElement.setAttribute("rel", "manifest");
      manifestElement.setAttribute("href", manifestURL);
      document.head.appendChild(manifestElement);
    };

    const manifest = getCustomerManifest();
    console.log(manifest);
    attachManifestToDom(manifest);
  </script>

  <script>
    document.getElementById("noti-form").addEventListener("submit", (e) => {
      e.preventDefault();
      console.log(e);
      const f = new FormData(e.target);
      const payload = f.get("payload");
      axios({
        method: "POST",
        url: "/notification",
        data: JSON.parse(payload),
      })
        .then((res) => {
          document.getElementById("noti-res").textContent = res.data;
          console.log(res);
        })
        .catch((err) => console.error(err));
    });
  </script>
  <style>
    .textarea {
      width: 100%;
      min-height: 200px;
    }
    .br-x1 {
      margin-left: 1rem;
    }
    .br-y2 {
      margin-top: 2rem;
    }
    .br-y3 {
      margin-top: 3rem;
    }
    .flex-box {
      display: flex;
      align-items: flex-start;
      flex-direction: column;
    }
  </style>
</html>
